{"version":3,"file":"storagetify.js","sources":["../src/js/TagSet.js","../src/js/index.js"],"sourcesContent":["/**\r\n *  标签集合\r\n */\r\nclass TagSet {\r\n  constructor(tag, cache) {\r\n    //标签的缓存Key\r\n    this.tag = Array.isArray(tag) ? tag : [tag]\r\n\r\n    //缓存句柄\r\n    this.handler = cache\r\n  }\r\n\r\n  set(key, value, expire = null) {\r\n    this.handler.set(key, value, expire)\r\n\r\n    this.append(key)\r\n  }\r\n\r\n  append(key) {\r\n    for (const tag of this.tag) {\r\n      //读取标签\r\n      const tagItems = this.handler.getTagItems(tag)\r\n\r\n      //判断标签是否在数组里,不再就直接加入\r\n      if (!tagItems.includes(key)) {\r\n        //加入数组\r\n        tagItems.push(key)\r\n\r\n        //重新设置回去\r\n        this.handler.set(tag, tagItems)\r\n      }\r\n    }\r\n  }\r\n\r\n  clear() {\r\n    for (const tag of this.tag) {\r\n      const tagItems = this.handler.getTagItems(tag)\r\n\r\n      //分别遍历删除所有的缓存\r\n      for (const cacheKey of tagItems) {\r\n        this.handler.delete(cacheKey)\r\n      }\r\n      //再删除标签\r\n      this.handler.delete(tag)\r\n    }\r\n  }\r\n}\r\n\r\nexport default TagSet\r\n","import TagSet from './TagSet'\r\n\r\nclass Storagetify {\r\n  \r\n  constructor(options = {}) {\r\n    this.type = options.type || 'local' //默认驱动是 localStorage\r\n    this.expire = options.expire || 0\r\n    this.prefix = options.prefix || ''\r\n    this.serialize = options.serialize || JSON.stringify\r\n    this.deserialize = options.deserialize || JSON.parse\r\n    this.storage = window[`${this.type}Storage`]\r\n  }\r\n\r\n  getKey(key) {\r\n    return this.prefix + key\r\n  }\r\n\r\n  set(key, value, expire = null) {\r\n    const cacheValue = {\r\n      value,\r\n      expire:\r\n        expire || this.expire !== 0\r\n          ? Date.now() + (expire || this.expire) * 1000\r\n          : 0,\r\n    }\r\n    try {\r\n      this.storage.setItem(this.getKey(key), this.serialize(cacheValue))\r\n      return true\r\n    } catch (error) {\r\n      return false\r\n    }\r\n  }\r\n\r\n  has(key) {\r\n    return this.storage.getItem(this.getKey(key)) !== null\r\n  }\r\n\r\n  get(key, defaultValue = null) {\r\n    const cacheValue = this.storage.getItem(this.getKey(key))\r\n    if (cacheValue) {\r\n      const parsedValue = this.deserialize(cacheValue)\r\n      if (parsedValue.expire === 0 || parsedValue.expire >= Date.now()) {\r\n        return parsedValue.value\r\n      }\r\n      this.delete(key)\r\n    }\r\n    return defaultValue\r\n  }\r\n\r\n  delete(key) {\r\n    this.storage.removeItem(this.getKey(key))\r\n  }\r\n\r\n  clear() {\r\n    this.storage.clear()\r\n  }\r\n\r\n  remember(key, value, expire = null) {\r\n    const cachedValue = this.get(key)\r\n    if (cachedValue !== null) {\r\n      return cachedValue\r\n    }\r\n\r\n    if (typeof value === 'function') {\r\n      //允许第二个参数是一个函数\r\n      const computedValue = value()\r\n      this.set(key, computedValue, expire)\r\n      return computedValue\r\n    }\r\n    this.set(key, value, expire)\r\n    return value\r\n  }\r\n\r\n  inc(key, step = 1) {\r\n    const cachedValue = this.get(key, 0)\r\n    if (typeof cachedValue === 'number') {\r\n      this.set(key, cachedValue + step)\r\n    }\r\n  }\r\n\r\n  tag(tag) {\r\n    return new TagSet(tag, this)\r\n  }\r\n\r\n  dec(key, step = 1) {\r\n    this.inc(key, -step)\r\n  }\r\n\r\n  //获取并删除缓存\r\n  pull(key) {\r\n    let value = this.get(key)\r\n    this.delete(key)\r\n    return value\r\n  }\r\n\r\n  push(key, value) {\r\n    const cachedValue = this.get(key, [])\r\n    if (Array.isArray(cachedValue)) {\r\n      cachedValue.push(value)\r\n      this.set(key, cachedValue)\r\n    }\r\n  }\r\n\r\n  store(type) {\r\n    return new this.constructor({\r\n      type,\r\n      expire: this.expire,\r\n      prefix: this.prefix,\r\n      serialize: this.serialize,\r\n      deserialize: this.deserialize,\r\n    })\r\n  }\r\n\r\n  getTagItems(tag) {\r\n    return this.get(tag, [])\r\n  }\r\n}\r\n\r\nexport default Storagetify\r\n"],"names":["TagSet","constructor","tag","cache","Array","isArray","handler","set","key","value","expire","append","tagItems","getTagItems","includes","push","clear","cacheKey","delete","Storagetify","options","type","prefix","serialize","JSON","stringify","deserialize","parse","storage","window","getKey","cacheValue","Date","now","setItem","error","has","getItem","get","defaultValue","parsedValue","removeItem","remember","cachedValue","computedValue","inc","step","dec","pull","store"],"mappings":"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"}